<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMA-WA: Gerador de Planilha</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#075E54">
    <link rel="icon" type="image/png" href="icon-192x192.png">
    
    <style>
        /* CSS GERAL E VARI√ÅVEIS (REPETI√á√ÉO NECESS√ÅRIA PARA ARQUIVOS SEPARADOS) */
        :root {
            --primary-green: #075E54;
            --secondary-green: #25D366;
            --bg-light: #F0F2F5;
            --bg-white: #FFFFFF;
            --text-dark: #111B21;
            --text-gray: #667781;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            background-color: var(--bg-light);
            color: var(--text-dark);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: 90%;
            max-width: 800px;
            padding: 20px;
        }

        /* HEADER E BOT√ÉO VOLTAR */
        .header-app {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        .header-app h1 {
            margin: 0 0 0 15px;
            font-size: 1.8em;
            color: var(--primary-green);
        }
        .btn-voltar {
            background: none;
            border: none;
            font-size: 2em;
            color: var(--text-gray);
            cursor: pointer;
            padding: 5px;
            line-height: 1;
            text-decoration: none;
        }
        .btn-voltar:hover {
            color: var(--text-dark);
        }
        
        /* √ÅREAS PRINCIPAIS */
        #import-area, #mapping-area, #result-area {
            background-color: var(--bg-white);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        /* Mapeamento de Colunas */
        .campo-map {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .campo-map label {
            width: 150px;
            font-weight: 600;
        }
        .campo-map select {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        
        /* BOT√ÉO DE A√á√ÉO */
        #btn-gerar-planilha {
            background-color: var(--primary-green);
            color: white;
            padding: 12px 25px;
            font-size: 1.1em;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
            width: 100%;
        }
        #btn-gerar-planilha:hover:not(:disabled) {
            background-color: #0d9488;
        }
        #btn-gerar-planilha:disabled {
            background-color: var(--text-gray);
            cursor: not-allowed;
        }
        
        .coluna-dica {
            font-size: 0.8em;
            color: var(--text-gray);
            margin-top: 5px;
        }
        #template-preview {
            white-space: pre-wrap;
            background-color: #f7f7f7;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #eee;
            margin-top: 15px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>

    <div class="container">
        
        <div class="header-app">
            <a href="index.html" class="btn-voltar" title="Voltar para o In√≠cio">&#x2190;</a> 
            <h1>Gerador de Planilha de Disparo</h1>
        </div>

        <div id="import-area">
            <h2>Passo 1: Importar Dados de Origem</h2>
            <p>Carregue a planilha que cont√©m os dados das consultas (Nome, Telefone, Data, etc.).</p>
            <input type="file" id="file-input" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel">
            <p id="feedback-importacao" class="coluna-dica" style="color: red;"></p>
        </div>

        <div id="mapping-area" style="display: none;">
            <h2>Passo 2: Mapeamento dos Campos</h2>
            <p>Indique qual coluna da sua planilha corresponde a cada campo da mensagem. <span style="font-weight: bold; color: var(--primary-green);">O mapeamento padr√£o foi aplicado.</span></p>
            
            <div class="campo-map">
                <label for="coluna-numero">üìû N√∫mero (Col. 1)</label>
                <select id="coluna-numero"></select>
            </div>
            <div class="campo-map">
                <label for="coluna-nome">üë§ Nome do Paciente</label>
                <select id="coluna-nome"></select>
            </div>
            <div class="campo-map">
                <label for="coluna-data">üìÖ Data da Consulta</label>
                <select id="coluna-data"></select>
            </div>
            <div class="campo-map">
                <label for="coluna-horario">üïí Hor√°rio</label>
                <select id="coluna-horario"></select>
            </div>
            <div class="campo-map">
                <label for="coluna-medico">üë®‚Äç‚öïÔ∏è Nome do Profissional</label>
                <select id="coluna-medico"></select>
            </div>
            <div class="campo-map">
                <label for="coluna-especialidade">üî¨ Especialidade</label>
                <select id="coluna-especialidade"></select>
            </div>
            
            <p class="coluna-dica">Pr√©-visualiza√ß√£o da Mensagem (usando a primeira linha de dados):</p>
            <div id="template-preview"></div>
        </div>
        
        <div id="result-area" style="display: none;">
            <h2>Passo 3: Gerar Planilha</h2>
            <button id="btn-gerar-planilha" disabled>Gerar Planilha de Envio (0 linhas)</button>
            <p id="feedback-geracao" class="coluna-dica" style="margin-top: 15px;"></p>
        </div>
        
    </div>

    <script>
        // VARI√ÅVEIS GLOBAIS
        let dadosOrigem = []; // Dados brutos lidos da planilha
        let colunasDisponiveis = []; // Nomes das colunas (A, B, C...)
        
        // Elementos DOM
        const fileInput = document.getElementById('file-input');
        const feedbackImportacao = document.getElementById('feedback-importacao');
        const mappingArea = document.getElementById('mapping-area');
        const resultArea = document.getElementById('result-area');
        const btnGerar = document.getElementById('btn-gerar-planilha');
        const feedbackGeracao = document.getElementById('feedback-geracao');
        const templatePreview = document.getElementById('template-preview');
        
        // Mapeamento de IDs para os seletores (mant√©m o controle)
        const mapeamentoCampos = {
            'coluna-numero': 'N√∫mero',
            'coluna-nome': 'Nome do Paciente',
            'coluna-data': 'Data',
            'coluna-horario': 'Hor√°rio',
            'coluna-medico': 'Profissional',
            'coluna-especialidade': 'Especialidade'
        };
        
        // Mapeamento Padr√£o de Colunas (√çndice 0-based)
        const DEFAULT_MAPPING = {
            'coluna-numero': 20, // U
            'coluna-nome': 10,   // K
            'coluna-data': 3,    // D
            'coluna-horario': 9, // J
            'coluna-medico': 6,  // G
            'coluna-especialidade': 28 // AC
        };


        // O TEMPLATE DA MENSAGEM (Com Formata√ß√£o WhatsApp)
        const TEMPLATE_MENSAGEM = `*CIS/UNINOVAFAPI ‚Äì LEMBRETE DE AGENDAMENTO*

*Nome:* [nome do paciente]
*Data:* [data da consulta]
*Hor√°rio:* [horario da consulta]
*Profissional:* [nome do medico]
*Especialidade:* [especialidade]

""üìå*OBRIGATORIO:*
Apresente a *GUIA AUTORIZADA DO SUS (data, hor√°rio e carimbo)* mais *PEDIDO M√âDICO PREENCHIDO*
Leve: *RG, CPF, comprovante de resid√™ncia e cart√£o do SUS ( menor: certid√£o com CPF).*

‚ùó*SEM ESSES DOCUMENTOS, O ATENDIMENTO N√ÉO SER√Å REALIZADO.*‚ùó

*RESPONDA:*
1Ô∏è‚É£ Confirmo presen√ßa
2Ô∏è‚É£ Desejo cancelar

‚ö†Ô∏è*CHEGUE COM ANTECED√äNCIA. ATRASOS PODEM IMPEDIR O ATENDIMENTO.*`;

        // ----------------------------------------------------------------------
        // FUN√á√ïES DE UTILIDADE
        // ----------------------------------------------------------------------

        /**
         * @description Cria o array de colunas dispon√≠veis (A, B, C... AA, AB, AC).
         * @param {number} maxCol - N√∫mero m√°ximo de colunas usadas.
         */
        function gerarColunas(maxCol) {
            const cols = [];
            
            // Limitando a um m√°ximo de 29 colunas (A a AC) conforme solicitado.
            const limite = Math.min(maxCol, 29); 
            
            for (let i = 0; i < limite; i++) {
                let letra = '';
                let temp = i;
                
                // L√≥gica de convers√£o de √≠ndice para nome de coluna (Excel style)
                while (temp >= 0) {
                    const resto = temp % 26;
                    letra = String.fromCharCode(65 + resto) + letra;
                    temp = Math.floor(temp / 26) - 1;
                }
                
                // Exibe Letra (√çndice + 1)
                cols.push({ letra: letra, indice: i, nomeExibicao: `${letra} (Col. ${i + 1})` }); 
            }
            return cols;
        }
        
        /**
         * @description Preenche todos os <select>s com as colunas dispon√≠veis.
         */
        function popularSelects() {
            for (const id in mapeamentoCampos) {
                const select = document.getElementById(id);
                select.innerHTML = ''; // Limpa op√ß√µes anteriores
                
                // Op√ß√£o padr√£o (Obrigat√≥rio selecionar)
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = `--- Selecione a Coluna para ${mapeamentoCampos[id]} ---`;
                defaultOption.disabled = true;
                defaultOption.selected = true;
                select.appendChild(defaultOption);

                colunasDisponiveis.forEach(col => {
                    const option = document.createElement('option');
                    option.value = col.indice;
                    option.textContent = col.nomeExibicao;
                    select.appendChild(option);
                });
            }
        }
        
        /**
         * @description Aplica o mapeamento padr√£o U, K, D, J, G, AC, se dispon√≠vel.
         */
        function aplicarMapeamentoPadrao() {
            for (const id in DEFAULT_MAPPING) {
                const select = document.getElementById(id);
                const desiredIndex = DEFAULT_MAPPING[id];

                // Verifica se a coluna padr√£o existe na planilha antes de selecionar
                if (desiredIndex < colunasDisponiveis.length) {
                    select.value = desiredIndex.toString();
                }
            }
        }


        /**
         * @description Formata o n√∫mero de telefone (apenas d√≠gitos), aplica o 9, remove 0 inicial e lida com n√∫meros m√∫ltiplos.
         * @param {string} numeroBruto - N√∫mero bruto, que pode conter '/'.
         * @returns {Array<string>} Array de n√∫meros formatados (somente 11 d√≠gitos).
         */
        function formatarNumero(numeroBruto) {
            if (!numeroBruto) return [];

            // 1. Separa os n√∫meros (pelo separador '/' ou v√≠rgula)
            const numeros = String(numeroBruto).split(/[/\,]/).map(n => n.trim());
            const numerosFormatados = [];

            numeros.forEach(num => {
                if (!num) return;

                // 2. Limpa: remove tudo que n√£o √© d√≠gito
                let limpo = num.replace(/\D/g, '');

                // 3. Remove 0 inicial se o n√∫mero tiver mais de 10 d√≠gitos (para n√£o afetar DDDs v√°lidos)
                if (limpo.startsWith('0') && limpo.length > 10) {
                    limpo = limpo.substring(1);
                }

                // Deve ser 11 d√≠gitos (DD + 9 + 8 d√≠gitos) ou 10 d√≠gitos (DD + 8 d√≠gitos)
                const tamanho = limpo.length;

                if (tamanho === 11) {
                    // J√° est√° no formato completo esperado (DD9XXXXXXXX)
                    numerosFormatados.push(limpo);

                } else if (tamanho === 10) {
                    // Est√° faltando o 9. Adiciona o 9 ap√≥s o DDD (primeiros 2 d√≠gitos)
                    const ddd = limpo.substring(0, 2);
                    const restante = limpo.substring(2);
                    const comNonoDigito = ddd + '9' + restante;
                    numerosFormatados.push(comNonoDigito);
                }
                // N√∫meros com outros tamanhos s√£o ignorados (como 8 ou 9, que n√£o t√™m DDD).
            });

            return numerosFormatados; // Pode retornar 0, 1, ou mais n√∫meros
        }

        
        /**
         * @description Limpa o nome, removendo dados ap√≥s o primeiro par√™ntese (.
         * Ex: "NOME SOBRENOME (DATA DE NASCIMENTO)" -> "NOME SOBRENOME"
         * @param {string} nomeCompleto - Nome bruto.
         * @returns {string} Nome limpo.
         */
        function limparNome(nomeCompleto) {
            // Garante que √© uma string
            nomeCompleto = String(nomeCompleto || '').trim();
            const indexParenteses = nomeCompleto.indexOf('(');
            
            if (indexParenteses !== -1) {
                // Pega tudo antes do '(' e remove espa√ßos em branco extras
                return nomeCompleto.substring(0, indexParenteses).trim();
            }
            return nomeCompleto; // Retorna o nome limpo se n√£o tiver par√™nteses
        }

        // ----------------------------------------------------------------------
        // FUN√á√ïES DE LEITURA E PROCESSAMENTO
        // ----------------------------------------------------------------------
        
        /**
         * @description Converte o array de dados crus, gera o preview e prepara a interface.
         * @param {Array<Object>} dados - Dados brutos lidos.
         */
        function processarDados(dados) {
            feedbackImportacao.textContent = '';
            
            // Remove o cabe√ßalho (dados.slice(1)) e filtra linhas que s√£o completamente vazias 
            // (onde nenhuma c√©lula tem conte√∫do n√£o-vazio).
            dadosOrigem = dados.slice(1).filter(row => 
                row.length > 0 && row.some(cell => String(cell || '').trim() !== '')
            ); 
            
            if (dadosOrigem.length === 0) {
                feedbackImportacao.textContent = 'Erro: Nenhuma linha de dados v√°lida encontrada ap√≥s o cabe√ßalho.';
                mappingArea.style.display = 'none';
                resultArea.style.display = 'none';
                return;
            }
            
            // Assume que o n√∫mero de colunas √© o tamanho do cabe√ßalho
            const maxColunas = dados[0].length;
            colunasDisponiveis = gerarColunas(maxColunas);
            
            popularSelects();
            aplicarMapeamentoPadrao(); // <--- Aplica o mapeamento padr√£o
            
            // Exibe as √°reas de mapeamento e resultado
            mappingArea.style.display = 'block';
            resultArea.style.display = 'block';
            
            // Atualiza a pr√©-visualiza√ß√£o com os dados da primeira linha
            verificarMapeamento(); // Chama para verificar e tamb√©m atualizar o preview.
            
            btnGerar.disabled = true;
            feedbackImportacao.textContent = `‚úÖ ${dadosOrigem.length} linhas de dados e ${colunasDisponiveis.length} colunas dispon√≠veis (${colunasDisponiveis[0].nomeExibicao} a ${colunasDisponiveis[colunasDisponiveis.length - 1].nomeExibicao}).`;
        }
        
        // Fun√ß√µes lerCSV e lerXLSX (sem altera√ß√µes)
        function lerCSV(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const allRows = text.split('\n').filter(r => r.trim() !== '');
                const dataArray = allRows.map(row => {
                    // Express√£o regular aprimorada para lidar com CSVs complexos, mantida a original para consist√™ncia
                    const matches = row.match(/(".*?"|[^",]+)(?=\s*,\s*|\s*$)/g);
                    return matches ? matches.map(m => m.replace(/(^"|"$)/g, '').trim()) : [];
                });
                processarDados(dataArray);
            };
            reader.readAsText(file);
        }

        function lerXLSX(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const dataArray = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                processarDados(dataArray);
            };
            reader.readAsArrayBuffer(file);
        }
        
        // ----------------------------------------------------------------------
        // PR√â-VISUALIZA√á√ÉO
        // ----------------------------------------------------------------------
        
        /**
         * @description Constr√≥i e exibe o template preenchido com a primeira linha de dados.
         */
        function atualizarPreviewTemplate() {
            // Se n√£o h√° dados, mostra o template padr√£o
            if (dadosOrigem.length === 0) {
                templatePreview.textContent = TEMPLATE_MENSAGEM; 
                return;
            }
            
            // 1. Captura os √≠ndices das colunas selecionadas
            const indices = {};
            for (const id in mapeamentoCampos) {
                const select = document.getElementById(id);
                // Usa -1 se n√£o estiver selecionado (value = "")
                indices[id] = select.value !== '' ? parseInt(select.value) : -1; 
            }

            const linhaOrigem = dadosOrigem[0]; // Pega a primeira linha de dados

            const campos = {};
            
            // Fun√ß√£o auxiliar para obter o valor do campo
            const getCampo = (key, defaultText) => {
                const index = indices[key];
                // CORRE√á√ÉO: Usando linhaOrigem[index] corretamente
                let valor = (index !== -1 && linhaOrigem[index] !== undefined && String(linhaOrigem[index]).trim() !== '') 
                            ? String(linhaOrigem[index]) : `[${defaultText}]`;

                if (key === 'coluna-nome' && !valor.startsWith('[')) {
                    return limparNome(valor); // Aplica a limpeza do nome
                }
                return valor;
            };
            
            const numeroBruto = getCampo('coluna-numero', 'n√∫mero de telefone');
            // Formata o n√∫mero (para visualiza√ß√£o, pega apenas o primeiro n√∫mero se houver m√∫ltiplos)
            const numerosFormatados = formatarNumero(numeroBruto);
            const numeroPreview = numerosFormatados.length > 0 ? numerosFormatados[0] : `[N√∫mero Inv√°lido/N√£o Mapeado]`;

            // 2. Preenche os campos com os dados da primeira linha
            campos['nome do paciente'] = getCampo('coluna-nome', 'nome do paciente');
            campos['data da consulta'] = getCampo('coluna-data', 'data da consulta');
            campos['horario da consulta'] = getCampo('coluna-horario', 'horario da consulta');
            campos['nome do medico'] = getCampo('coluna-medico', 'nome do medico');
            campos['especialidade'] = getCampo('coluna-especialidade', 'especialidade');
            
            // Adiciona a visualiza√ß√£o do n√∫mero formatado no topo do preview
            let mensagemPrevia = `üìû *N√∫mero Formatado (Principal):* ${numeroPreview}\n---\n\n` + TEMPLATE_MENSAGEM;
            
            // 3. Substitui [placeholder] pelo valor na pr√©via
            for (const placeholder in campos) {
                const regex = new RegExp(`\\[${placeholder}\\]`, 'gi');
                mensagemPrevia = mensagemPrevia.replace(regex, campos[placeholder]);
            }
            
            templatePreview.textContent = mensagemPrevia;
        }

        // ----------------------------------------------------------------------
        // L√ìGICA DE GERA√á√ÉO
        // ----------------------------------------------------------------------

        /**
         * @description Verifica se todos os campos obrigat√≥rios est√£o mapeados.
         */
        function verificarMapeamento() {
            let todosMapeados = true;
            for (const id in mapeamentoCampos) {
                const select = document.getElementById(id);
                if (!select.value && select.value !== 0) { // Verifica se tem valor (o √≠ndice 0 √© v√°lido)
                    todosMapeados = false;
                    break;
                }
            }
            
            // Sempre atualiza a pr√©-visualiza√ß√£o ao mudar o mapeamento
            atualizarPreviewTemplate();
            
            btnGerar.disabled = !todosMapeados;
            if (todosMapeados) {
                 btnGerar.textContent = `Gerar Planilha de Envio (${dadosOrigem.length} linhas)`;
                 feedbackGeracao.textContent = '';
            } else {
                 btnGerar.textContent = 'Preencha todos os campos obrigat√≥rios';
                 feedbackGeracao.textContent = 'Aten√ß√£o: Todos os 6 campos devem ser mapeados para gerar o arquivo.';
            }
        }

        /**
         * @description Constr√≥i a planilha final de duas colunas (N√∫mero, Mensagem).
         */
        function gerarPlanilhaFinal() {
            if (btnGerar.disabled) return;
            
            feedbackGeracao.textContent = 'Processando...';
            
            // Captura os √≠ndices das colunas selecionadas
            const indices = {};
            for (const id in mapeamentoCampos) {
                // O valor do select √© o √≠ndice da coluna (0-based)
                indices[id] = parseInt(document.getElementById(id).value); 
            }

            const dadosFinais = [['Numero', 'Mensagem']]; // Cabe√ßalho do novo arquivo
            let linhasGeradas = 0;

            dadosOrigem.forEach(linhaOrigem => {
                // 1. Extrai e Formata o(s) N√∫mero(s)
                const numeroBruto = linhaOrigem[indices['coluna-numero']];
                const numerosFormatados = formatarNumero(numeroBruto); // Retorna um array de 0, 1 ou mais n√∫meros

                if (numerosFormatados.length === 0) {
                    return; // Ignora linhas sem n√∫mero v√°lido
                }

                // 2. Extrai os outros campos e aplica a limpeza
                const campos = {};
                
                // Aplica a regra de limpeza apenas na coluna de Nome
                let nomeBruto = String(linhaOrigem[indices['coluna-nome']] || 'N√ÉO INFORMADO');
                campos['nome do paciente'] = limparNome(nomeBruto);
                
                campos['data da consulta'] = linhaOrigem[indices['coluna-data']] || 'N√ÉO INFORMADA';
                campos['horario da consulta'] = linhaOrigem[indices['coluna-horario']] || 'N√ÉO INFORMADO';
                campos['nome do medico'] = linhaOrigem[indices['coluna-medico']] || 'N√ÉO INFORMADO';
                campos['especialidade'] = linhaOrigem[indices['coluna-especialidade']] || 'N√ÉO INFORMADA';

                // 3. Monta a Mensagem substituindo os placeholders no Template
                let mensagemFinal = TEMPLATE_MENSAGEM;
                
                for (const placeholder in campos) {
                    // Substitui [nome do paciente], [data da consulta], etc.
                    const regex = new RegExp(`\\[${placeholder}\\]`, 'gi');
                    mensagemFinal = mensagemFinal.replace(regex, campos[placeholder]);
                }
                
                // 4. Adiciona cada n√∫mero formatado como uma linha separada
                numerosFormatados.forEach(num => {
                    // Adiciona a nova linha: [N√∫mero Limpo (11 d√≠gitos), Mensagem Completa]
                    dadosFinais.push([num, mensagemFinal]);
                    linhasGeradas++;
                });
            });
            
            // 5. Cria e Baixa o Arquivo XLSX
            const ws = XLSX.utils.aoa_to_sheet(dadosFinais);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Disparo_EMA_WA");
            XLSX.writeFile(wb, "EMA-WA_Planilha_Disparo.xlsx");

            feedbackGeracao.textContent = `‚úÖ Arquivo "EMA-WA_Planilha_Disparo.xlsx" gerado com ${linhasGeradas} mensagens (${dadosOrigem.length} registros de origem)!`;
        }
        
        // ----------------------------------------------------------------------
        // LISTENERS
        // ----------------------------------------------------------------------

        // A. Listener de Upload de Arquivo
        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            feedbackImportacao.textContent = 'Carregando... Por favor, aguarde.';
            
            if (file.name.endsWith('.csv')) {
                lerCSV(file);
            } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                lerXLSX(file);
            } else {
                feedbackImportacao.textContent = 'Erro: Formato n√£o suportado. Use .csv, .xlsx ou .xls.';
                fileInput.value = '';
                mappingArea.style.display = 'none';
                resultArea.style.display = 'none';
            }
        });

        // B. Listener de Mudan√ßa nos Selects (Verifica Mapeamento e Atualiza Pr√©via)
        mappingArea.addEventListener('change', (event) => {
            // S√≥ dispara se o elemento mudado for um <select>
            if (event.target.tagName === 'SELECT') {
                verificarMapeamento(); 
            }
        });
        
        // C. Listener do Bot√£o Gerar
        btnGerar.addEventListener('click', gerarPlanilhaFinal);

        // D. Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', () => {
             // Oculta √°reas no in√≠cio
             mappingArea.style.display = 'none';
             resultArea.style.display = 'none';
             
             // Define o template inicial na pr√©-visualiza√ß√£o
             templatePreview.textContent = TEMPLATE_MENSAGEM;
        });
    </script>
</body>
</html>