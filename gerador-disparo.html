<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMA-WA: Gerador de Planilha</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#075E54">
    <link rel="icon" type="image/png" href="icon-192x192.png">
    
    <style>
        /* CSS GERAL E VARI√ÅVEIS (REPETI√á√ÉO NECESS√ÅRIA PARA ARQUIVOS SEPARADOS) */
        :root {
            --primary-green: #075E54;
            --secondary-green: #25D366;
            --bg-light: #F0F2F5;
            --bg-white: #FFFFFF;
            --text-dark: #111B21;
            --text-gray: #667781;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            background-color: var(--bg-light);
            color: var(--text-dark);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: 90%;
            max-width: 800px;
            padding: 20px;
        }

        /* HEADER E BOT√ÉO VOLTAR */
        .header-app {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        .header-app h1 {
            margin: 0 0 0 15px;
            font-size: 1.8em;
            color: var(--primary-green);
        }
        .btn-voltar {
            background: none;
            border: none;
            font-size: 2em;
            color: var(--text-gray);
            cursor: pointer;
            padding: 5px;
            line-height: 1;
            text-decoration: none;
        }
        .btn-voltar:hover {
            color: var(--text-dark);
        }
        
        /* √ÅREAS PRINCIPAIS */
        #import-area, #mapping-area, #result-area {
            background-color: var(--bg-white);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        /* Mapeamento de Colunas */
        .campo-map {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .campo-map label {
            width: 150px;
            font-weight: 600;
        }
        .campo-map select {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        
        /* Checkbox CEO Styling */
        .campo-opcional {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            margin-bottom: 20px;
            border-top: 1px dashed #eee;
            padding-top: 10px;
        }
        .campo-opcional label {
            font-weight: 600;
            color: var(--primary-green);
            margin-right: 10px;
            font-size: 1em;
            width: auto;
        }
        .campo-opcional input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: var(--primary-green);
        }
        
        /* BOT√ÉO DE A√á√ÉO */
        #btn-gerar-planilha {
            background-color: var(--primary-green);
            color: white;
            padding: 12px 25px;
            font-size: 1.1em;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
            width: 100%;
        }
        #btn-gerar-planilha:hover:not(:disabled) {
            background-color: #0d9488;
        }
        #btn-gerar-planilha:disabled {
            background-color: var(--text-gray);
            cursor: not-allowed;
        }
        
        .coluna-dica {
            font-size: 0.8em;
            color: var(--text-gray);
            margin-top: 5px;
        }
        #template-preview {
            white-space: pre-wrap;
            background-color: #f7f7f7;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #eee;
            margin-top: 15px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>

    <div class="container">
        
        <div class="header-app">
            <a href="index.html" class="btn-voltar" title="Voltar para o In√≠cio">&#x2190;</a> 
            <h1>Gerador de Planilha de Disparo</h1>
        </div>

        <div id="import-area">
            <h2>Passo 1: Importar Dados de Origem</h2>
            <p>Carregue a planilha que cont√©m os dados das consultas (Nome, Telefone, Data, etc.).</p>
            <input type="file" id="file-input" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel">
            <p id="feedback-importacao" class="coluna-dica" style="color: red;"></p>
        </div>

        <div id="mapping-area" style="display: none;">
            <h2>Passo 2: Mapeamento dos Campos</h2>
            <p>Indique qual coluna da sua planilha corresponde a cada campo da mensagem. <span style="font-weight: bold; color: var(--primary-green);">O mapeamento padr√£o foi aplicado.</span></p>
            
            <div class="campo-map">
                <label for="coluna-numero">üìû N√∫mero (Col. 1)</label>
                <select id="coluna-numero"></select>
            </div>
            <div class="campo-map">
                <label for="coluna-nome">üë§ Nome do Paciente</label>
                <select id="coluna-nome"></select>
            </div>
            <div class="campo-map">
                <label for="coluna-data">üìÖ Data da Consulta</label>
                <select id="coluna-data"></select>
            </div>
            <div class="campo-map">
                <label for="coluna-horario">üïí Hor√°rio</label>
                <select id="coluna-horario"></select>
            </div>
            <div class="campo-map">
                <label for="coluna-medico">üë®‚Äç‚öïÔ∏è Nome do Profissional</label>
                <select id="coluna-medico"></select>
            </div>
            <div class="campo-map">
                <label for="coluna-especialidade">üî¨ Especialidade</label>
                <select id="coluna-especialidade"></select>
            </div>
            
            <div class="campo-opcional">
                <label for="checkbox-ceo">CEO (Documenta√ß√£o Detalhada)</label>
                <input type="checkbox" id="checkbox-ceo">
            </div>

            <p class="coluna-dica">Pr√©-visualiza√ß√£o da Mensagem (usando a primeira linha de dados):</p>
            <div id="template-preview"></div>
        </div>
        
        <div id="result-area" style="display: none;">
            <h2>Passo 3: Gerar Planilha</h2>
            <button id="btn-gerar-planilha" disabled>Gerar Planilha de Envio (0 linhas)</button>
            <p id="feedback-geracao" class="coluna-dica" style="margin-top: 15px;"></p>
        </div>
        
    </div>

    <script>
        // VARI√ÅVEIS GLOBAIS
        let dadosOrigem = []; // Dados brutos lidos da planilha
        let colunasDisponiveis = []; // Nomes das colunas (A, B, C...)
        
        // Elementos DOM
        const fileInput = document.getElementById('file-input');
        const feedbackImportacao = document.getElementById('feedback-importacao');
        const mappingArea = document.getElementById('mapping-area');
        const resultArea = document.getElementById('result-area');
        const btnGerar = document.getElementById('btn-gerar-planilha');
        const feedbackGeracao = document.getElementById('feedback-geracao');
        const templatePreview = document.getElementById('template-preview');
        const checkboxCEO = document.getElementById('checkbox-ceo'); // NOVO ELEMENTO
        
        // Mapeamento de IDs para os seletores (mant√©m o controle)
        const mapeamentoCampos = {
            'coluna-numero': 'N√∫mero',
            'coluna-nome': 'Nome do Paciente',
            'coluna-data': 'Data',
            'coluna-horario': 'Hor√°rio',
            'coluna-medico': 'Profissional',
            'coluna-especialidade': 'Especialidade'
        };
        
        // Mapeamento Padr√£o de Colunas (√çndice 0-based)
        const DEFAULT_MAPPING = {
            'coluna-numero': 20, // U
            'coluna-nome': 10,   // K
            'coluna-data': 3,    // D
            'coluna-horario': 9, // J
            'coluna-medico': 6,  // G
            'coluna-especialidade': 28 // AC
        };

        // ----------------------------------------------------------------------
        // TEMPLATES DE MENSAGEM (Condicionais)
        // ----------------------------------------------------------------------

        // TEMPLATE PADR√ÉO (Checkbox CEO N√ÉO marcado)
        const TEMPLATE_MENSAGEM_PADRAO = `*CIS/UNINOVAFAPI ‚Äì LEMBRETE DE AGENDAMENTO*

*Nome:* [nome do paciente]
*Data:* [data da consulta]
*Hor√°rio:* [horario da consulta]
*Profissional:* [nome do medico]
*Especialidade:* [especialidade]

""*OBRIGATORIO:*
Apresente a *GUIA AUTORIZADA DO SUS (data, hor√°rio e carimbo)* mais *PEDIDO M√âDICO PREENCHIDO*

*TRAZER*
*DOCUMENTOS:* RG, CPF, comprovante de resid√™ncia e cart√£o do SUS
*MENOR:* RG COM CPF OU certid√£o com CPF

*SEM ESSES DOCUMENTOS, O ATENDIMENTO N√ÉO SER√Å REALIZADO.*

*RESPONDA:*
1- Confirmo presen√ßa
2- Desejo cancelar

*CHEGUE COM ANTECED√äNCIA. ATRASOS PODEM IMPEDIR O ATENDIMENTO.*`;

        // TEMPLATE CEO (Checkbox CEO MARCADO)
        const TEMPLATE_MENSAGEM_CEO = `*CIS/UNINOVAFAPI ‚Äì LEMBRETE DE AGENDAMENTO*

*Nome:* [nome do paciente]
*Data:* [data da consulta]
*Hor√°rio:* [horario da consulta]
*Profissional:* [nome do medico]
*Especialidade:* [especialidade]

""*OBRIGATORIO:*
Apresente a *GUIA AUTORIZADA DO SUS (data, hor√°rio e carimbo)* mais *PEDIDO M√âDICO PREENCHIDO*

*TRAZER*
*COPIAS:* RG, CPF, comprovante de resid√™ncia e cart√£o do SUS
*MENOR:* RG COM CPF OU certid√£o com CPF ,
*IMPORTANTE QUE O RESPONSAVEL DO MENOR TRAGA COPIAS DO SEU RG COM CPF.*

*SEM ESSES DOCUMENTOS, O ATENDIMENTO N√ÉO SER√Å REALIZADO.*

*RESPONDA:*
1- Confirmo presen√ßa
2- Desejo cancelar

*CHEGUE COM ANTECED√äNCIA. ATRASOS PODEM IMPEDIR O ATENDIMENTO.*`;

        /**
         * @description Retorna o template de mensagem correto com base no estado do checkbox CEO.
         * @returns {string} O template de mensagem.
         */
        function getTemplateMensagem() {
            return checkboxCEO.checked ? TEMPLATE_MENSAGEM_CEO : TEMPLATE_MENSAGEM_PADRAO;
        }
        
        // ----------------------------------------------------------------------
        // FUN√á√ïES DE UTILIDADE (Mantidas as originais)
        // ----------------------------------------------------------------------

        function gerarColunas(maxCol) {
            const cols = [];
            const limite = Math.min(maxCol, 29); 
            
            for (let i = 0; i < limite; i++) {
                let letra = '';
                let temp = i;
                
                while (temp >= 0) {
                    const resto = temp % 26;
                    letra = String.fromCharCode(65 + resto) + letra;
                    temp = Math.floor(temp / 26) - 1;
                }
                
                cols.push({ letra: letra, indice: i, nomeExibicao: `${letra} (Col. ${i + 1})` }); 
            }
            return cols;
        }
        
        function popularSelects() {
            for (const id in mapeamentoCampos) {
                const select = document.getElementById(id);
                select.innerHTML = ''; 
                
                const defaultOption = document.createElement('option');
                defaultOption.value = '';
                defaultOption.textContent = `--- Selecione a Coluna para ${mapeamentoCampos[id]} ---`;
                defaultOption.disabled = true;
                defaultOption.selected = true;
                select.appendChild(defaultOption);

                colunasDisponiveis.forEach(col => {
                    const option = document.createElement('option');
                    option.value = col.indice;
                    option.textContent = col.nomeExibicao;
                    select.appendChild(option);
                });
            }
        }
        
        function aplicarMapeamentoPadrao() {
            for (const id in DEFAULT_MAPPING) {
                const select = document.getElementById(id);
                const desiredIndex = DEFAULT_MAPPING[id];

                if (desiredIndex < colunasDisponiveis.length) {
                    select.value = desiredIndex.toString();
                }
            }
        }


        function formatarNumero(numeroBruto) {
            if (!numeroBruto) return [];

            const numeros = String(numeroBruto).split(/[/\,]/).map(n => n.trim());
            const numerosFormatados = [];

            numeros.forEach(num => {
                if (!num) return;

                let limpo = num.replace(/\D/g, '');

                if (limpo.startsWith('0') && limpo.length > 10) {
                    limpo = limpo.substring(1);
                }

                const tamanho = limpo.length;

                if (tamanho === 11) {
                    numerosFormatados.push(limpo);

                } else if (tamanho === 10) {
                    const ddd = limpo.substring(0, 2);
                    const restante = limpo.substring(2);
                    const comNonoDigito = ddd + '9' + restante;
                    numerosFormatados.push(comNonoDigito);
                }
            });

            return numerosFormatados;
        }

        
        function limparNome(nomeCompleto) {
            nomeCompleto = String(nomeCompleto || '').trim();
            const indexParenteses = nomeCompleto.indexOf('(');
            
            if (indexParenteses !== -1) {
                return nomeCompleto.substring(0, indexParenteses).trim();
            }
            return nomeCompleto;
        }

        // ----------------------------------------------------------------------
        // FUN√á√ïES DE LEITURA E PROCESSAMENTO (Mantidas as originais)
        // ----------------------------------------------------------------------
        
        function processarDados(dados) {
            feedbackImportacao.textContent = '';
            
            dadosOrigem = dados.slice(1).filter(row => 
                row.length > 0 && row.some(cell => String(cell || '').trim() !== '')
            ); 
            
            if (dadosOrigem.length === 0) {
                feedbackImportacao.textContent = 'Erro: Nenhuma linha de dados v√°lida encontrada ap√≥s o cabe√ßalho.';
                mappingArea.style.display = 'none';
                resultArea.style.display = 'none';
                return;
            }
            
            const maxColunas = dados[0].length;
            colunasDisponiveis = gerarColunas(maxColunas);
            
            popularSelects();
            aplicarMapeamentoPadrao(); 
            
            mappingArea.style.display = 'block';
            resultArea.style.display = 'block';
            
            verificarMapeamento(); 
            
            btnGerar.disabled = true;
            feedbackImportacao.textContent = `‚úÖ ${dadosOrigem.length} linhas de dados e ${colunasDisponiveis.length} colunas dispon√≠veis (${colunasDisponiveis[0].nomeExibicao} a ${colunasDisponiveis[colunasDisponiveis.length - 1].nomeExibicao}).`;
        }
        
        function lerCSV(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const allRows = text.split('\n').filter(r => r.trim() !== '');
                const dataArray = allRows.map(row => {
                    const matches = row.match(/(".*?"|[^",]+)(?=\s*,\s*|\s*$)/g);
                    return matches ? matches.map(m => m.replace(/(^"|"$)/g, '').trim()) : [];
                });
                processarDados(dataArray);
            };
            reader.readAsText(file);
        }

        function lerXLSX(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                const dataArray = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                processarDados(dataArray);
            };
            reader.readAsArrayBuffer(file);
        }
        
        // ----------------------------------------------------------------------
        // PR√â-VISUALIZA√á√ÉO (Atualizada para usar o template condicional)
        // ----------------------------------------------------------------------
        
        function atualizarPreviewTemplate() {
            const mensagemBase = getTemplateMensagem(); // Pega o template correto
            
            if (dadosOrigem.length === 0) {
                templatePreview.textContent = mensagemBase; 
                return;
            }
            
            const indices = {};
            for (const id in mapeamentoCampos) {
                const select = document.getElementById(id);
                indices[id] = select.value !== '' ? parseInt(select.value) : -1; 
            }

            const linhaOrigem = dadosOrigem[0]; 

            const campos = {};
            
            const getCampo = (key, defaultText) => {
                const index = indices[key];
                let valor = (index !== -1 && linhaOrigem[index] !== undefined && String(linhaOrigem[index]).trim() !== '') 
                            ? String(linhaOrigem[index]) : `[${defaultText}]`;

                if (key === 'coluna-nome' && !valor.startsWith('[')) {
                    return limparNome(valor);
                }
                return valor;
            };
            
            const numeroBruto = getCampo('coluna-numero', 'n√∫mero de telefone');
            const numerosFormatados = formatarNumero(numeroBruto);
            const numeroPreview = numerosFormatados.length > 0 ? numerosFormatados[0] : `[N√∫mero Inv√°lido/N√£o Mapeado]`;
            const nomePreview = getCampo('coluna-nome', 'nome do paciente'); // Adicionado o nome para a pr√©via

            campos['nome do paciente'] = nomePreview;
            campos['data da consulta'] = getCampo('coluna-data', 'data da consulta');
            campos['horario da consulta'] = getCampo('coluna-horario', 'horario da consulta');
            campos['nome do medico'] = getCampo('coluna-medico', 'nome do medico');
            campos['especialidade'] = getCampo('coluna-especialidade', 'especialidade');
            
            let mensagemPrevia = `üìû *N√∫mero Formatado (Principal):* ${numeroPreview}\nüë§ *Nome:* ${nomePreview}\n---\n\n` + mensagemBase; // Atualizado para incluir o nome
            
            for (const placeholder in campos) {
                const regex = new RegExp(`\\[${placeholder}\\]`, 'gi');
                mensagemPrevia = mensagemPrevia.replace(regex, campos[placeholder]);
            }
            
            templatePreview.textContent = mensagemPrevia;
        }

        // ----------------------------------------------------------------------
        // L√ìGICA DE GERA√á√ÉO (Atualizada para incluir Nome e template condicional)
        // ----------------------------------------------------------------------

        function verificarMapeamento() {
            let todosMapeados = true;
            for (const id in mapeamentoCampos) {
                const select = document.getElementById(id);
                if (!select.value && select.value !== 0) { 
                    todosMapeados = false;
                    break;
                }
            }
            
            // Tamb√©m atualiza o preview quando o checkbox muda.
            atualizarPreviewTemplate(); 
            
            btnGerar.disabled = !todosMapeados;
            if (todosMapeados) {
                 btnGerar.textContent = `Gerar Planilha de Envio (${dadosOrigem.length} linhas)`;
                 feedbackGeracao.textContent = '';
            } else {
                 btnGerar.textContent = 'Preencha todos os campos obrigat√≥rios';
                 feedbackGeracao.textContent = 'Aten√ß√£o: Todos os 6 campos devem ser mapeados para gerar o arquivo.';
            }
        }

        function gerarPlanilhaFinal() {
            if (btnGerar.disabled) return;
            
            feedbackGeracao.textContent = 'Processando...';
            
            const templateMensagem = getTemplateMensagem(); // Pega o template correto para a gera√ß√£o.

            const indices = {};
            for (const id in mapeamentoCampos) {
                indices[id] = parseInt(document.getElementById(id).value); 
            }

            // ATUALIZADO: Adicionando a coluna 'Nome'
            const dadosFinais = [['Numero', 'Nome', 'Mensagem']]; 
            let linhasGeradas = 0;

            dadosOrigem.forEach(linhaOrigem => {
                // 1. Extrai e Formata o(s) N√∫mero(s)
                const numeroBruto = linhaOrigem[indices['coluna-numero']];
                const numerosFormatados = formatarNumero(numeroBruto); 

                if (numerosFormatados.length === 0) {
                    return; 
                }

                // 2. Extrai os outros campos e aplica a limpeza
                const campos = {};
                
                let nomeBruto = String(linhaOrigem[indices['coluna-nome']] || 'N√ÉO INFORMADO');
                const nomeLimpo = limparNome(nomeBruto); // Guarda o nome limpo para a planilha e o template
                campos['nome do paciente'] = nomeLimpo;
                
                campos['data da consulta'] = linhaOrigem[indices['coluna-data']] || 'N√ÉO INFORMADA';
                campos['horario da consulta'] = linhaOrigem[indices['coluna-horario']] || 'N√ÉO INFORMADO';
                campos['nome do medico'] = linhaOrigem[indices['coluna-medico']] || 'N√ÉO INFORMADO';
                campos['especialidade'] = linhaOrigem[indices['coluna-especialidade']] || 'N√ÉO INFORMADA';

                // 3. Monta a Mensagem usando o template CONDICIONAL
                let mensagemFinal = templateMensagem;
                
                for (const placeholder in campos) {
                    const regex = new RegExp(`\\[${placeholder}\\]`, 'gi');
                    mensagemFinal = mensagemFinal.replace(regex, campos[placeholder]);
                }
                
                // 4. Adiciona cada n√∫mero formatado como uma linha separada
                numerosFormatados.forEach(num => {
                    // ATUALIZADO: Inclui o nome na segunda coluna
                    dadosFinais.push([num, nomeLimpo, mensagemFinal]); 
                    linhasGeradas++;
                });
            });
            
            // 5. Cria e Baixa o Arquivo XLSX
            const ws = XLSX.utils.aoa_to_sheet(dadosFinais);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Disparo_EMA_WA");
            XLSX.writeFile(wb, "EMA-WA_Planilha_Disparo.xlsx");

            feedbackGeracao.textContent = `‚úÖ Arquivo "EMA-WA_Planilha_Disparo.xlsx" gerado com ${linhasGeradas} mensagens (${dadosOrigem.length} registros de origem)!`;
        }
        
        // ----------------------------------------------------------------------
        // LISTENERS (Adicionado listener para o checkbox CEO)
        // ----------------------------------------------------------------------

        // A. Listener de Upload de Arquivo
        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            feedbackImportacao.textContent = 'Carregando... Por favor, aguarde.';
            
            if (file.name.endsWith('.csv')) {
                lerCSV(file);
            } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                lerXLSX(file);
            } else {
                feedbackImportacao.textContent = 'Erro: Formato n√£o suportado. Use .csv, .xlsx ou .xls.';
                fileInput.value = '';
                mappingArea.style.display = 'none';
                resultArea.style.display = 'none';
            }
        });

        // B. Listener de Mudan√ßa nos Selects E no Checkbox (Verifica Mapeamento e Atualiza Pr√©via)
        mappingArea.addEventListener('change', (event) => {
            // Se o elemento mudado for um <select> OU o checkbox CEO
            if (event.target.tagName === 'SELECT' || event.target.id === 'checkbox-ceo') { 
                verificarMapeamento(); 
            }
        });
        
        // C. Listener do Bot√£o Gerar
        btnGerar.addEventListener('click', gerarPlanilhaFinal);

        // D. Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', () => {
             mappingArea.style.display = 'none';
             resultArea.style.display = 'none';
             
             // Define o template inicial na pr√©-visualiza√ß√£o (usa o getTemplateMensagem para pegar o padr√£o/CEO)
             templatePreview.textContent = getTemplateMensagem(); 
        });
    </script>
</body>
</html>
