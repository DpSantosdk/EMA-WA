<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMA-WA: Assistente de Envio Manual</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        /* CSS Minimalista (Inspirado no WhatsApp Web) */
        :root {
            --primary-green: #075E54;
            --secondary-green: #25D366;
            --bg-light: #F0F2F5;
            --bg-white: #FFFFFF;
            --text-dark: #111B21;
            --text-gray: #667781;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            background-color: var(--bg-light);
            color: var(--text-dark);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: 90%;
            max-width: 800px;
            padding: 20px;
        }

        /* √Årea de Importa√ß√£o */
        #import-area {
            background-color: var(--bg-white);
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        input[type="file"] {
            display: block;
            margin-top: 10px;
        }

        /* Bot√£o Principal de A√ß√£o */
        #btn-enviar-proxima {
            background-color: var(--primary-green);
            color: white;
            padding: 12px 25px;
            font-size: 1.1em;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
            width: 100%;
            margin-bottom: 20px;
        }
        #btn-enviar-proxima:hover:not(:disabled) {
            background-color: #054a3e;
        }
        #btn-enviar-proxima:disabled {
            background-color: var(--text-gray);
            cursor: not-allowed;
        }

        /* Fila de Mensagens */
        #fila-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .cartao-mensagem {
            background-color: var(--bg-white);
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
        }
        
        /* Destaque para o Pr√≥ximo Item (Visual mais sutil) */
        .cartao-mensagem.destaque {
            border: 2px solid var(--secondary-green);
            box-shadow: 0 0 10px rgba(37, 211, 102, 0.6);
            order: -1; /* Mant√©m o destaque no topo */
        }
        
        /* Item Enviado (Checklist) */
        .cartao-mensagem.enviado {
            background-color: #e9fbe9; /* Verde muito claro */
            opacity: 0.7;
        }
        
        .cartao-mensagem h4 {
            margin: 0 0 5px 0;
            font-size: 1em;
            color: var(--primary-green);
            display: inline-block;
        }
        .cartao-mensagem p {
            margin: 5px 0 10px 0;
            font-size: 0.9em;
            color: var(--text-dark);
            white-space: pre-wrap;
        }
        
        /* Bot√£o de A√ß√£o no Cart√£o */
        .btn-individual {
            background-color: var(--secondary-green);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            float: right;
        }
        .btn-individual:disabled {
            background-color: var(--text-gray);
            cursor: not-allowed;
            float: right;
        }
        
        .status-badge {
            font-size: 0.7em;
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status-badge.pendente { background-color: #ffeccf; color: #b87c2b; }
        .status-badge.enviado { background-color: #d1f4d9; color: var(--primary-green); }
    </style>
</head>
<body>

    <div class="container">
        <h1>‚≠ê EMA-WA | Assistente de Envio</h1>
        
        <div id="import-area">
            <h2>üü¶ 1. Importar Planilha (CSV ou XLSX)</h2>
            <p>Selecione um arquivo.</p>
            <input type="file" id="file-input" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel">
            <p id="feedback-importacao" style="color: red; margin-top: 10px;"></p>
        </div>

        <button id="btn-enviar-proxima" disabled>Carregue um arquivo para come√ßar</button>
        
        <div id="fila-container">
            <p id="loading-message" style="text-align: center; color: var(--text-gray);">Aguardando a importa√ß√£o da planilha...</p>
        </div>
    </div>

    <script>
        // VARI√ÅVEIS GLOBAIS
        let filaMensagens = [];
        const filaContainer = document.getElementById('fila-container');
        const btnEnviarProxima = document.getElementById('btn-enviar-proxima');
        const fileInput = document.getElementById('file-input');
        const feedbackImportacao = document.getElementById('feedback-importacao');
        const loadingMessage = document.getElementById('loading-message');

        // ----------------------------------------------------------------------
        // FUN√á√ïES DE LEITURA DE ARQUIVOS (CSV e XLSX)
        // ----------------------------------------------------------------------

        /**
         * @description Converte o array de dados crus para o formato de fila, assumindo a posi√ß√£o das colunas.
         * @param {Array<Object>} dados - Dados brutos lidos.
         * @param {boolean} ignorarPrimeiraLinha - Se deve ignorar o cabe√ßalho (True para XLSX e CSV).
         */
        function processarDados(dados, ignorarPrimeiraLinha = true) {
            loadingMessage.style.display = 'none'; // Esconde a mensagem de carregamento/aguardando

            if (dados.length === 0) {
                feedbackImportacao.textContent = 'Erro: O arquivo est√° vazio.';
                filaContainer.innerHTML = '';
                btnEnviarProxima.disabled = true;
                fileInput.value = ''; // CORRE√á√ÉO: Reseta o input para permitir o re-upload do mesmo arquivo
                return;
            }
            
            // Se deve ignorar o cabe√ßalho, remove o primeiro elemento
            const dadosReais = ignorarPrimeiraLinha ? dados.slice(1) : dados;

            // Mapeia os dados, assumindo a posi√ß√£o: √çndice 0 = N√∫mero, √çndice 1 = Mensagem
            filaMensagens = dadosReais
                // Filtra para garantir que as duas primeiras colunas n√£o estejam vazias
                .filter(row => row[0] && row[1]) 
                .map((row, index) => ({
                    id: index + 1,
                    // Limpa caracteres n√£o num√©ricos do n√∫mero (√çndice 0)
                    numero: String(row[0]).replace(/\D/g, ''), 
                    // Mensagem (√çndice 1)
                    mensagem: String(row[1]), 
                    status: 'Pendente'
                }));

            if (filaMensagens.length === 0) {
                feedbackImportacao.textContent = 'Erro: Nenhuma linha v√°lida (com n√∫mero e mensagem nas colunas 1 e 2) encontrada.';
                filaContainer.innerHTML = '';
                btnEnviarProxima.disabled = true;
                fileInput.value = ''; // CORRE√á√ÉO: Reseta o input
                return;
            }

            feedbackImportacao.textContent = `‚úÖ ${filaMensagens.length} mensagens carregadas com sucesso!`;
            renderizarFila();
        }

        /**
         * @description Lida com a leitura de arquivos CSV (JS Puro).
         * @param {File} file - O arquivo CSV.
         */
        function lerCSV(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                
                const allRows = text.split('\n').filter(r => r.trim() !== '');
                
                // Convers√£o simples de CSV para Array de Arrays
                const dataArray = allRows.map(row => {
                    // Usa express√£o regular para lidar com CSV que pode ter aspas
                    const matches = row.match(/(".*?"|[^",]+)(?=\s*,\s*|\s*$)/g);
                    return matches ? matches.map(m => m.replace(/(^"|"$)/g, '').trim()) : [];
                });
                
                processarDados(dataArray, true); // Ignora a primeira linha
                fileInput.value = ''; // CORRE√á√ÉO: Reseta o input ap√≥s o processamento
            };
            reader.readAsText(file);
        }

        /**
         * @description Lida com a leitura de arquivos XLSX (SheetJS).
         * @param {File} file - O arquivo XLSX.
         */
        function lerXLSX(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                
                // Assume que a primeira planilha √© a que cont√©m os dados
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                
                // Converte a planilha para Array de Arrays (sem nomes de cabe√ßalho)
                const dataArray = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                processarDados(dataArray, true); // Ignora a primeira linha
                fileInput.value = ''; // CORRE√á√ÉO: Reseta o input ap√≥s o processamento
            };
            reader.readAsArrayBuffer(file);
        }

        // Listener para o input de arquivo
        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            feedbackImportacao.textContent = 'Carregando... Por favor, aguarde.';
            filaMensagens = []; // Limpa a fila anterior
            filaContainer.innerHTML = ''; // Limpa a visualiza√ß√£o anterior
            
            // Verifica o tipo do arquivo
            if (file.name.endsWith('.csv')) {
                lerCSV(file);
            } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                lerXLSX(file);
            } else {
                feedbackImportacao.textContent = 'Erro: Formato de arquivo n√£o suportado. Use .csv, .xlsx ou .xls.';
                fileInput.value = ''; // CORRE√á√ÉO: Reseta o input
            }
        });

        // ----------------------------------------------------------------------
        // FUN√á√ïES DE FLUXO (CORE)
        // ----------------------------------------------------------------------

        /**
         * @description Atualiza o Status do Item e renderiza novamente a fila.
         * @param {number} id - ID do item da fila.
         */
        function marcarComoEnviado(id) {
            const item = filaMensagens.find(i => i.id === id);
            if (item && item.status === 'Pendente') {
                item.status = 'Enviado';
                renderizarFila();
                
                // Rolagem para o pr√≥ximo item destacado
                const proximoDestaque = document.querySelector('.cartao-mensagem.destaque');
                if (proximoDestaque) {
                    proximoDestaque.scrollIntoView({ behavior: 'smooth', block: 'center' });
                } else {
                    btnEnviarProxima.textContent = "‚úÖ Campanha Conclu√≠da";
                    btnEnviarProxima.style.backgroundColor = '#1DA851'; // Cor de sucesso
                    alert('üéâ Fila de Envio Conclu√≠da! Voc√™ enviou todas as mensagens.');
                }
            }
        }

        /**
         * @description Constr√≥i o URL do WhatsApp e abre uma nova aba.
         * @param {number} id - ID do item da fila.
         * @param {string} numero - N√∫mero do destinat√°rio.
         * @param {string} mensagem - Mensagem personalizada.
         */
        function enviarMensagem(id, numero, mensagem) {
            const mensagemEncoded = encodeURIComponent(mensagem);
            
            // Formato de link do WhatsApp: wa.me/CODIGOPAISNUMERO?text=MENSAGEM
            const url = `https://wa.me/${numero}?text=${mensagemEncoded}`;
            
            window.open(url, '_blank');
            
            // Marca como enviado ap√≥s a a√ß√£o do usu√°rio no nosso sistema
            marcarComoEnviado(id);
        }

        /**
         * @description Renderiza a lista de cart√µes na interface.
         */
        function renderizarFila() {
            // Identifica o pr√≥ximo item Pendente
            const proximoItem = filaMensagens.find(item => item.status === 'Pendente');
            
            filaContainer.innerHTML = '';
            
            // Configura o Bot√£o Principal
            if (proximoItem) {
                btnEnviarProxima.disabled = false;
                btnEnviarProxima.textContent = `‚û° Enviar Pr√≥xima Mensagem (ID: ${proximoItem.id})`;
                btnEnviarProxima.style.backgroundColor = '#075E54'; // Cor ativa
                btnEnviarProxima.onclick = () => enviarMensagem(
                    proximoItem.id, 
                    proximoItem.numero, 
                    proximoItem.mensagem
                );
            } else if (filaMensagens.length > 0) {
                btnEnviarProxima.disabled = true;
                btnEnviarProxima.textContent = "‚úÖ Campanha Conclu√≠da";
                btnEnviarProxima.style.backgroundColor = '#1DA851'; // Cor de sucesso
            } else {
                // Estado inicial
                btnEnviarProxima.disabled = true;
                btnEnviarProxima.textContent = "Carregue um arquivo para come√ßar";
                btnEnviarProxima.style.backgroundColor = 'var(--text-gray)';
                loadingMessage.style.display = 'block'; // Mostra a mensagem inicial de novo
            }

            // Cria os cart√µes
            filaMensagens.forEach(item => {
                const isDestaque = proximoItem && item.id === proximoItem.id;
                const isEnviado = item.status === 'Enviado';

                const cartao = document.createElement('div');
                cartao.className = `cartao-mensagem ${isDestaque ? 'destaque' : ''} ${isEnviado ? 'enviado' : ''}`;
                cartao.id = `item-${item.id}`;

                const badgeClass = isEnviado ? 'enviado' : 'pendente';
                const badgeText = isEnviado ? 'ENVIADO' : 'PENDENTE';
                
                const numeroFormatado = item.numero; // Exibe o n√∫mero limpo

                // Conte√∫do HTML do cart√£o
                cartao.innerHTML = `
                    <button class="btn-individual" data-id="${item.id}" ${isEnviado ? 'disabled' : ''}>
                        ${isEnviado ? 'Conclu√≠do' : 'Abrir WhatsApp'}
                    </button>
                    <h4>[${item.id}] Destinat√°rio: ${numeroFormatado}</h4>
                    <span class="status-badge ${badgeClass}">${badgeText}</span>
                    <p>Mensagem: ${item.mensagem}</p>
                `;

                // Adiciona o evento de clique ao bot√£o individual
                const btn = cartao.querySelector('.btn-individual');
                if (!isEnviado) {
                    btn.onclick = () => enviarMensagem(item.id, item.numero, item.mensagem);
                }

                filaContainer.appendChild(cartao);
            });
        }

        // Inicia o sistema
        document.addEventListener('DOMContentLoaded', () => {
            if (filaMensagens.length === 0) {
                loadingMessage.style.display = 'block';
            }
        });
    </script>
</body>
</html>

